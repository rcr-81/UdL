(function(){var Dom=YAHOO.util.Dom,Event=YAHOO.util.Event;var $html=Alfresco.util.encodeHTML,$combine=Alfresco.util.combinePaths;Alfresco.dashlet.AuditApplication=function AuditApplication_constructor(htmlId){return Alfresco.dashlet.AuditApplication.superclass.constructor.call(this,"Alfresco.dashlet.AuditApplication",htmlId,["datatable","datasource","paginator","autocomplete"]);};YAHOO.extend(Alfresco.dashlet.AuditApplication,Alfresco.component.Base,{options:{componentId:"",application:"",valueFilter:"",limit:"",defaultRowsPerPage:10,rowsPerPage:"",additionalQueryParams:"",show_id_column:"",show_user_column:"",show_time_column:"",show_values_column:""},bodyContainer:null,entriesContainer:null,consecutiveRefreshMinimumDelay:300,searchBoxContainer:null,searchBoxLabelContainer:null,messageContainer:null,titleContainer:null,dataTable:null,dataSource:null,onReady:function AuditApplication_onReady(){this.titleContainer=Dom.get(this.id+"-title");this.bodyContainer=Dom.get(this.id+"-body");this.entriesContainer=Dom.get(this.id+"-entries");this.messageContainer=Dom.get(this.id+"-message");this.searchBoxContainer=Dom.get(this.id+"-searchWithinResultsFilter");this.searchBoxLabelContainer=Dom.get(this.id+"-searchWithinResultsFilterLabel");if(YAHOO.env.ua.webkit>0){Dom.removeClass(this.entriesContainer,"scrollableList");}Event.addListener(this.id+"-configure-link","click",this.onConfigClick,this,true);Event.addListener(this.id+"-refresh","click",this.onRefresh,this,true);Event.addListener(this.searchBoxContainer,"keyup",this.onSearchWithinResultsFilterKeyup,this,true);this.init();},init:function AuditApplication_init(){this.searchBoxLabelContainer.innerHTML=this.msg("audit.dashlet.searchWithinResults",0)+" :";this.searchBoxContainer.value="";Dom.removeClass(this.searchBoxContainer,"invalid-regex");Dom.removeClass(this.searchBoxContainer,"valid-regex");this.addUtilPrototypes();if(this.options.application!=""){var appHeader=this.options.application;var vfHeader=this.options.valueFilter?" "+this.msg("audit.dashlet.valuefilteredOn")+" "+this.options.valueFilter:"";var validLimit=this.options.limit!=""&&!isNaN(this.options.limit)&&!((this.options.limit*1)<1);var limitHeader=validLimit?" ("+this.options.limit+" max)":"";this.titleContainer.innerHTML=this.msg("audit.dashlet.header.default")+" : "+appHeader+vfHeader+limitHeader;Dom.removeClass(this.searchBoxContainer,"shy");Dom.removeClass(this.searchBoxLabelContainer,"shy");}else{this.titleContainer.innerHTML=this.msg("audit.dashlet.header.default");Dom.addClass(this.searchBoxContainer,"shy");Dom.addClass(this.searchBoxLabelContainer,"shy");}if(this.dataTable){this.dataTable.destroy();this.dataTable=null;}if(this.options.application!=""){this.setMessage();this.loadData();}else{this.setMessage(this.msg("audit.dashlet.notConfigured"));}},setMessage:function AuditApplication_setMessage(msgText){if(msgText){this.messageContainer.innerHTML=msgText;Dom.setStyle(this.messageContainer,"display","block");}else{this.messageContainer.innerHTML="";Dom.setStyle(this.messageContainer,"display","none");}},addUtilPrototypes:function AuditApplication_addUtilPrototypes(){String.prototype.swapHighlightMarkers=function(prefix){return this.replace(/\uFFFE/g,(prefix?prefix:"")+"<span class='regex-highlight'>").replace(/\uFFFF/g,"</span>");};String.prototype.trimHighlightMarkers=function(replacement){return this.replace(/[\uFFFE\uFFFF]/g,replacement?replacement:"");};String.prototype.sanitizeforHighlighting=function(text){var metacharacters="$()*+.?[^{|";return this.replace(/([\$\(\)\*\+\.\?\[\\\^\{\|])/g,function($0){return"\\"+$0;});};String.prototype.elideHighlightMarkers=function(open_marker_char,close_marker_char){var opened=false;var skip_next_close_stack=[];var rebuild="";var c="";for(var j=0;j<this.length;j++){c=this.charAt(j);if(c==open_marker_char){if(!opened){opened=true;rebuild+=c;}else{skip_next_close_stack.push(true);}}else{if(c==close_marker_char){if(skip_next_close_stack.length==0){rebuild+=c;opened=false;}else{skip_next_close_stack.pop();}}else{rebuild+=c;}}}return rebuild;};},loadData:function AuditApplication_loadData(){var myColumnDefs=[{key:"id",label:this.msg("audit.dashlet.field.label.id"),sortable:true,resizeable:true,formatter:function(elCell,oRecord,oColumn,oData){elCell.innerHTML=(oData+"").swapHighlightMarkers();}},{key:"user",label:this.msg("audit.dashlet.field.label.user"),sortable:true,resizeable:true,formatter:function(elCell,oRecord,oColumn,oData){var template=Alfresco.constants.URI_TEMPLATES.userprofilepage;var HTMLed_username=(oData+"").swapHighlightMarkers();var unmarked_username=(oData+"").trimHighlightMarkers();if(!(YAHOO.lang.isUndefined(template)||template.length===0||Alfresco.constants.PORTLET||unmarked_username=="null")){uri=Alfresco.util.uriTemplate("userprofilepage",{userid:unmarked_username});elCell.innerHTML="<a href='"+uri+"' class='theme-color-1'>"+HTMLed_username+"</a>";}else{elCell.innerHTML=HTMLed_username;}}},{key:"time",label:this.msg("audit.dashlet.field.label.time"),sortable:true,resizeable:true,formatter:function(elCell,oRecord,oColumn,oData){if(oData instanceof Date){var oDate=new Date(oData);elCell.innerHTML=YAHOO.util.Date.format(oDate,{format:"%e/%m %H:%M"});}else{elCell.innerHTML=(oData+"").swapHighlightMarkers();}}},{key:"values",label:this.msg("audit.dashlet.field.label.values"),sortable:true,resizeable:true,formatter:function(elCell,oRecord,oColumn,oData){var arrayAsString="";var noderef_regex=/[\w]+:\/\/\w+\/[\w]{8}-[\w]{4}-[\w]{4}-[\w]{4}-[\w]{12}/g;var marked_noderef_regex=/[\w\uFFFE\uFFFF]+:[\uFFFE\uFFFF]?([\uFFFE\uFFFF]?\/[\uFFFE\uFFFF]?){2}[\w\uFFFE\uFFFF]+\/[\w\uFFFE\uFFFF]+-[\w\uFFFE\uFFFF]+-[\w\uFFFE\uFFFF]+-[\w\uFFFE\uFFFF]+-[\w\uFFFE\uFFFF]+/g;var valuesArray=oData.split("\n");var multivalued=(valuesArray.length>1);for(pair_number in valuesArray){var raw_value=valuesArray[pair_number];var audit_key=raw_value.split(":",1);var audit_value=raw_value.split(/^[^:]*:/).pop();var unmarked_audit_value=audit_value.trimHighlightMarkers();var displayed_value=audit_value;var matches=audit_value.match(marked_noderef_regex);var unmarked_matches=unmarked_audit_value.match(noderef_regex);var prepended_space=YAHOO.env.ua.webkit>0?" ":"";if(unmarked_matches&&matches){var link_start="<a href='"+Alfresco.constants.URL_PAGECONTEXT+"document-details?nodeRef=";var link_class="' class='theme-color-1'>";var link_end="</a><br/>";for(var match_index=0;match_index<Math.min(matches.length,unmarked_matches.length);match_index++){var linked=link_start+$html(unmarked_matches[match_index])+link_class+matches[match_index].swapHighlightMarkers(prepended_space)+link_end;displayed_value=displayed_value.replace(matches[match_index],linked);}}displayed_value=displayed_value.swapHighlightMarkers(prepended_space);arrayAsString+="<li>"+(multivalued?"[ ":"")+(audit_key+"").swapHighlightMarkers()+" : "+displayed_value+(multivalued?" ] ":"")+"</li>";}elCell.innerHTML=arrayAsString;}}];var auditValueFilterquery=this.options.valueFilter?"&valueFilter="+encodeURI(this.options.valueFilter):"";var limitquery=this.options.limit?"&limit="+encodeURI(this.options.limit):"";var additionalQueryParams=this.options.additionalQueryParams?"&additionalQueryParams="+encodeURI(this.options.additionalQueryParams.replace(/&/g,"\uFFFF")):"";var dataSourceURI=Alfresco.constants.URL_SERVICECONTEXT+"components/dashlets/audit-application/entries?application="+encodeURI(this.options.application)+auditValueFilterquery+limitquery+additionalQueryParams;var myDataSource=new YAHOO.util.DataSource(dataSourceURI);myDataSource.responseType=YAHOO.util.XHRDataSource.TYPE_JSON;myDataSource.connXhrMode="queueRequests";myDataSource.responseSchema={resultsList:"entries",fields:[{key:"id",parser:"number"},{key:"user"},{key:"time",parser:function(oData){var unparsed=oData;if(YAHOO.env.ua.ie>0&&YAHOO.env.ua.ie<7){oData=oData.replace(/\-/ig,"/").split(".")[0];}else{if(YAHOO.env.ua.ie>=7){oData=oData.replace(/\-/ig,"/").replace(/T/ig," ").replace(/\.\d\d\d/ig,"").replace(/\+.*/ig,"");}else{if(YAHOO.env.ua.gecko>0&&YAHOO.env.ua.gecko<=1.9){oData=oData.replace(/\-/ig,"/").replace(/T/ig," ").split(".")[0];}}}var date=new Date(oData);if((date!="Invalid Date")&&!isNaN(date)){return date;}else{return unparsed;}}},{key:"values",parser:function(oData){var arrayAsString="";var keycount=0,i=0;for(prop in oData){keycount++;}var multivalued=(keycount>1);for(key in oData){arrayAsString+=key+":"+oData[key];if(multivalued&&i<keycount-1){arrayAsString+="\n";}i++;}return arrayAsString;}}],metaFields:{totalRecords:"count"}};var dashlet=this;myDataSource.doBeforeCallback=function(req,raw,res,cb){var currentCount=res.results.length;if(req){var filterOutput=dashlet.applyRegexFilterOnResponse(req,res);res.results=filterOutput.filtered;if(filterOutput.regexStatus=="valid"){Dom.removeClass(dashlet.searchBoxContainer,"invalid-regex");Dom.addClass(dashlet.searchBoxContainer,"valid-regex");var filteredCount=filterOutput.filtered.length;dashlet.searchBoxLabelContainer.innerHTML=dashlet.msg("audit.dashlet.filteredResults",filteredCount,currentCount-filteredCount)+" :";}else{if(filterOutput.regexStatus=="invalid"){Dom.removeClass(dashlet.searchBoxContainer,"valid-regex");Dom.addClass(dashlet.searchBoxContainer,"invalid-regex");dashlet.searchBoxLabelContainer.innerHTML=dashlet.msg("audit.dashlet.invalidSearch")+" :";}}}else{Dom.removeClass(dashlet.searchBoxContainer,"invalid-regex");Dom.removeClass(dashlet.searchBoxContainer,"valid-regex");dashlet.searchBoxLabelContainer.innerHTML=dashlet.msg("audit.dashlet.searchWithinResults",currentCount)+" :";}return res;};var dtOptions={paginator:new YAHOO.widget.Paginator({rowsPerPage:this.options.rowsPerPage==""?this.options.defaultRowsPerPage:this.options.rowsPerPage,firstPageLinkLabel:this.msg("audit.dashlet.firstPageLinkLabel"),previousPageLinkLabel:this.msg("audit.dashlet.previousPageLinkLabel"),nextPageLinkLabel:this.msg("audit.dashlet.nextPageLinkLabel"),lastPageLinkLabel:this.msg("audit.dashlet.lastPageLinkLabel"),pageReportTemplate:this.msg("audit.dashlet.pageReportTemplate")}),MSG_EMPTY:this.msg("audit.dashlet.noEntries"),MSG_LOADING:this.msg("audit.dashlet.loading"),sortedBy:{key:"id",dir:"desc"}};var myDataTable=new YAHOO.widget.DataTable(this.entriesContainer,myColumnDefs,myDataSource,dtOptions);myDataTable.handleDataReturnPayload=function(oRequest,oResponse,oPayload){return oPayload;};this.entriesDataSource=myDataSource;this.dataTable=myDataTable;this.showOrHideColumn(0,this.options.show_id_column);this.showOrHideColumn(1,this.options.show_user_column);this.showOrHideColumn(2,this.options.show_time_column);this.showOrHideColumn(3,this.options.show_values_column);},showOrHideColumn:function AuditApplication_showOrHideColumn(column_number,show){if(show=="show"){this.dataTable.showColumn(column_number);}else{this.dataTable.hideColumn(column_number);}},applyRegexFilterOnResponse:function AuditApplication_applyRegexFilterOnResponse(req,res){var output={};var input=res.results||[];var filtered=[];var i,l=input.length;function indexOfWrapper(array,string_to_match){if(array.indexOf){return array.indexOf(string_to_match);}else{for(var index=0;index<array.length;index++){if(array[index]===string_to_match){return index;}}return -1;}}if(req){var querystring=req.replace("&searchWithinResults=","");var negation_predicate_present=false;var firstchar=querystring.substr(0,1);if(firstchar=="+"||firstchar=="-"){querystring=querystring.substr(1);if(firstchar=="-"){negation_predicate_present=true;}}var splittedQueryElements=querystring.split(":");var isColonSeparated=splittedQueryElements.length>1;var field=isColonSeparated?splittedQueryElements.shift():"values";var to_match=isColonSeparated?splittedQueryElements.join(":"):querystring;var to_match=to_match.replace(":",":\\s*");var re_to_match;try{re_to_match=new RegExp(to_match,"mi");output.regexStatus="valid";}catch(e){output.regexStatus="invalid";output.filtered=filtered;return output;}for(i=0;i<l;++i){if(input[i][field] instanceof Date){input[i][field]=YAHOO.util.Date.format(input[i][field],{format:"%e/%m %H:%M"});}var field_value=(input[i][field]+"").trimHighlightMarkers(" ");var remainder=field_value;var at_least_one_match=false;var previous_remaining_match;var matching_strings=[];var deferred_matching_strings=[];var highlight_open_marker="\uFFFE";var highlight_close_marker="\uFFFF";while(remaining_match=re_to_match.exec(remainder)){at_least_one_match=true;var alreadyHighlighted=(indexOfWrapper(matching_strings,remaining_match[0])!=-1);if((!remaining_match!=!negation_predicate_present)&&!alreadyHighlighted){var remaining_match_regex=remaining_match[0].sanitizeforHighlighting();if(remaining_match[0]){var remainder_matches=remainder.match(new RegExp(remaining_match_regex,"g"));if(remainder_matches){if(remainder_matches.length>1){if(indexOfWrapper(deferred_matching_strings,remaining_match[0])==-1){deferred_matching_strings.push(remaining_match[0]);}}else{field_value=field_value.replace(new RegExp(remaining_match_regex,"g"),highlight_open_marker+remaining_match[0]+highlight_close_marker);matching_strings.push(remaining_match[0]);}}}}var new_remainder=remainder.substr(remaining_match[0].length==0?1:remaining_match.index+remaining_match[0].length);if(!new_remainder||remainder==new_remainder){break;}else{remainder=new_remainder;}previous_remaining_match=remaining_match;}if(!negation_predicate_present){for(var deferred_index=0;deferred_index<deferred_matching_strings.length;deferred_index++){if(indexOfWrapper(matching_strings,deferred_matching_strings[deferred_index])==-1){var deferred_regex=new RegExp(deferred_matching_strings[deferred_index].sanitizeforHighlighting(),"g");field_value=field_value.replace(deferred_regex,highlight_open_marker+deferred_matching_strings[deferred_index]+highlight_close_marker);}}field_value=field_value.replace(new RegExp(highlight_close_marker+highlight_open_marker,"g"),"").replace(new RegExp(highlight_open_marker+highlight_close_marker,"g"),"");input[i][field]=field_value.elideHighlightMarkers(highlight_open_marker,highlight_close_marker);}if(!at_least_one_match!=!negation_predicate_present){filtered.push(input[i]);}}output.filtered=filtered;}else{output.regexStatus="empty";output.filtered=input;}return output;},refresh:function AuditApplication_refresh(){var oCallback={success:this.dataTable.onDataReturnInitializeTable,failure:this.dataTable.onDataReturnInitializeTable,scope:this.dataTable,argument:this.dataTable.getState()};var txnid=this.entriesDataSource.sendRequest(this.searchBoxContainer.value?"&searchWithinResults="+this.searchBoxContainer.value:"",oCallback);},refreshDataTable_SearchWithinResults:function AuditApplication_refreshDataTable_searchWithinResults(){var state=this.dataTable.getState();state.sortedBy={key:"id",dir:YAHOO.widget.DataTable.CLASS_DESC};var txnid=this.entriesDataSource.sendRequest(this.searchBoxContainer.value?"&searchWithinResults="+this.searchBoxContainer.value:"",{success:this.dataTable.onDataReturnInitializeTable,failure:this.dataTable.onDataReturnInitializeTable,scope:this.dataTable,argument:state});},lastButtonRefreshEventTimeStamp:null,onRefresh:function AuditApplication_onRefresh(e){if(e){Event.preventDefault(e);}this.lastButtonRefreshEventTimeStamp=new Date().getTime();var that=this;setTimeout(function(){var currentTime=new Date().getTime();if(currentTime-that.lastButtonRefreshEventTimeStamp>that.consecutiveRefreshMinimumDelay){that.dispatchButtonRefreshRequest();}},that.consecutiveRefreshMinimumDelay+100);},dispatchButtonRefreshRequest:function(){this.refresh();},lastKeyUpEventTimeStamp:null,onSearchWithinResultsFilterKeyup:function AuditApplication_onSearchWithinResultsFilterKeyup(e){this.lastKeyUpEventTimeStamp=new Date().getTime();var that=this;setTimeout(function(){var currentTime=new Date().getTime();if(currentTime-that.lastKeyUpEventTimeStamp>that.consecutiveRefreshMinimumDelay){that.dispatchKeyupRefreshRequest();}},that.consecutiveRefreshMinimumDelay+100);},dispatchKeyupRefreshRequest:function(){this.refreshDataTable_SearchWithinResults();},setupBoxListener:function(field){var configDialog=this.configDialog;YAHOO.util.Event.addListener(Dom.get(configDialog.id+"-checkbox-show_"+field+"_column"),"click",function(){Dom.get(configDialog.id+"-show_"+field+"_column").value=(this.checked?"show":"hide");});},onConfigClick:function AuditApplication_onConfigClick(e){var actionUrl=Alfresco.constants.URL_SERVICECONTEXT+"modules/dashlet/config/"+encodeURIComponent(this.options.componentId);Event.stopEvent(e);if(!this.configDialog){this.configDialog=new Alfresco.module.SimpleDialog(this.id+"-configDialog").setOptions({width:"50em",templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/dashlet/audit-application/config",actionUrl:actionUrl,onSuccess:{fn:function AuditApplication_onConfigure_callback(e){this.options.application=Dom.get(this.configDialog.id+"-application").value;this.options.valueFilter=Dom.get(this.configDialog.id+"-valueFilter").value;this.options.limit=Dom.get(this.configDialog.id+"-limit").value;if(isNaN(this.options.limit)||(this.options.limit*1)<1){this.options.limit="";}this.options.rowsPerPage=Dom.get(this.configDialog.id+"-rowsPerPage").value;if(isNaN(this.options.rowsPerPage)||(this.options.rowsPerPage*1)<1){this.options.rowsPerPage=this.options.defaultRowsPerPage;}this.options.additionalQueryParams=Dom.get(this.configDialog.id+"-additionalQueryParams").value;this.options.show_id_column=Dom.get(this.configDialog.id+"-show_id_column").value;this.options.show_user_column=Dom.get(this.configDialog.id+"-show_user_column").value;this.options.show_time_column=Dom.get(this.configDialog.id+"-show_time_column").value;this.options.show_values_column=Dom.get(this.configDialog.id+"-show_values_column").value;this.init();},scope:this},doSetupFormsValidation:{fn:function AuditApplication_doSetupForm_callback(form){Dom.get(this.configDialog.id+"-application").value=this.options.application;Dom.get(this.configDialog.id+"-valueFilter").value=this.options.valueFilter;if(isNaN(this.options.limit)||(this.options.limit*1)<1){Dom.get(this.configDialog.id+"-limit").value="";}else{Dom.get(this.configDialog.id+"-limit").value=this.options.limit;}if(isNaN(this.options.rowsPerPage)||(this.options.rowsPerPage*1)<1){Dom.get(this.configDialog.id+"-rowsPerPage").value=this.options.defaultRowsPerPage;}else{Dom.get(this.configDialog.id+"-rowsPerPage").value=this.options.rowsPerPage;}Dom.get(this.configDialog.id+"-additionalQueryParams").value=this.options.additionalQueryParams;Dom.get(this.configDialog.id+"-show_id_column").value=this.options.show_id_column;Dom.get(this.configDialog.id+"-checkbox-show_id_column").checked=(this.options.show_id_column=="show");Dom.get(this.configDialog.id+"-show_user_column").value=this.options.show_user_column;Dom.get(this.configDialog.id+"-checkbox-show_user_column").checked=(this.options.show_user_column=="show");Dom.get(this.configDialog.id+"-show_time_column").value=this.options.show_time_column;Dom.get(this.configDialog.id+"-checkbox-show_time_column").checked=(this.options.show_time_column=="show");Dom.get(this.configDialog.id+"-show_values_column").value=this.options.show_values_column;Dom.get(this.configDialog.id+"-checkbox-show_values_column").checked=(this.options.show_values_column=="show");this.setupBoxListener("id");this.setupBoxListener("user");this.setupBoxListener("time");this.setupBoxListener("values");var configDataSource=new YAHOO.util.XHRDataSource(Alfresco.constants.URL_SERVICECONTEXT+"modules/dashlets/audit-application/applist");configDataSource.responseType=YAHOO.util.XHRDataSource.TYPE_JSON;configDataSource.responseSchema={resultsList:"applications",fields:["name","path","enabled"]};var formatResult=function(oResultData,sQuery,sResultMatch){return oResultData.name+" ("+oResultData.path+")  -  enabled : "+oResultData.enabled;};var appHandler=function(sType,aArgs){var myAC=aArgs[0];var elLI=aArgs[1];var oData=aArgs[2];var appname=oData.name;if(appname.substring(0,1)==" "){appname=appname.substring(1);}myAC.getInputEl().value=appname;};var configDialogId=this.configDialog.id;var appAutoComplete=new YAHOO.widget.AutoComplete(configDialogId+"-application",configDialogId+"-application-select",configDataSource);appAutoComplete.resultTypeList=false;appAutoComplete.applyLocalFilter=true;appAutoComplete.queryMatchContains=true;appAutoComplete.formatResult=formatResult;appAutoComplete.itemSelectEvent.subscribe(appHandler);if(Dom.get(configDialogId+"-application").value==""){appAutoComplete.sendQuery(" ");}},scope:this}});}else{this.configDialog.setOptions({actionUrl:actionUrl});}this.configDialog.show();}});})();